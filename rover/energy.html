<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" dir="ltr">
 
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Energy Sim Sketch</title>

    <script type="text/javascript" src="../js/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="../js/flot/jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="../js/xml2json.js"></script>

</head>
 
<body onload="evolve_over_time();">


    <strong>battery_energy_charge: </strong><input class="sim_parameter_input" id="battery_energy_charge" type="range" step="1" min='0' max='33.3' /><br/>

    <strong>battery_charging_current: </strong><input class="sim_parameter_input" id="battery_charging_current" type="range" step="0.1" min='0' /><br/>
    <strong>solar_power_produced_avg: </strong><input class="sim_parameter_input" id="solar_power_produced_avg" type="range" step="0.1" min='0.1' max='15' />
    <br/><br/>
    

    <br/>
    
    <pre id="siminfo"></pre>
    <pre id="simresults"></pre>

    <div id="chart" style="height: 500px; width: 90%"></div>
    <br/>X: time<br/>

    <script type="text/javascript">


            //time
            var time_step = 0.08; //h
            var time = 0; //start at midnight
            var time_limit = 24;

            //time budgets
            var time_drive = 2; //h
            var time_comms = 3;


            //yr.no weather API url
            var weather_url = "http://​crossorigin.me/http://www.yr.no/place/Antarctica/Other/Greenwich_Island/forecast.xml";
            var weather_data = false; 

            //energy storage
            var battery_voltage = 3.7; //V
            var battery_cap = 9; //Ah
            var battery_energy_cap =  battery_voltage * battery_cap; //Wh (3.7V * 9Ah)
            var battery_charging_current = 0.5; //A
            var battery_energy_charge = 0; //initial charge 0
            var battery_percent_status_data = [];



            //energy production
            var solar_power_produced_avg = 5; //W
            var solar_energy_produced_per_day_avg = solar_power_produced_avg*24; //Wh
            
            var energy_produced = 0;
            var energy_consumed = 0;

            var energy_production_data = [];
            var energy_consumption_data = [];

            //distance traveled
            var drive_time_total = 0;

            //motors driving state
            var motors_on = false;

            //energy consumption
            //HEATING IS NOT CONSIDERED IN THIS MODEL

            var system_consumers = [
                                        {name: "mainboard", sleep: 0.01*3.3, active: 0.05*3.3, active_per_hour: 1},
                                        {name: "eps", sleep: 0.01*3.3, active: 0.05*3.3,  active_per_hour: 1},
                                    ];


            var comms_consumers = [ 
                                        {name: "rockblock", sleep: 0.01*5, active: 0.2*5, active_per_hour: 0.12}
                                    ];

            var drive_consumers = [

                                        {name: "M1", sleep: 0, active: 0.1*5,  active_per_hour: 1},
                                        {name: "M2", sleep: 0, active: 0.1*5,  active_per_hour: 1},
                                        {name: "M3", sleep: 0, active: 0.1*5, active_per_hour: 1},
                                        {name: "M4", sleep: 0, active: 0.1*5, active_per_hour: 1},
                                        {name: "M5", sleep: 0, active: 0.05*3.3, active_per_hour: 0.2},
                                        {name: "M6", sleep: 0, active: 0.05*3.3, active_per_hour: 0.2},
                                        {name: "M7", sleep: 0, active: 0.05*3.3, active_per_hour: 0.2}, 
                                        {name: "M8", sleep: 0, active: 0.05*3.3, active_per_hour: 0.2}

                                    ];



        !function ($) {

            //fetches weather asynchronously!
            get_weather_data(weather_url);

            console.log(get_solar_irradiance_data(40, -62, 200));



            $("#battery_charging_current").attr('max', solar_power_produced_avg/battery_voltage);

            $(".sim_parameter_input").change(function(event) {
                clear_sim();

                battery_charging_current = parseFloat($("#battery_charging_current").val());
                solar_power_produced_avg = parseFloat($("#solar_power_produced_avg").val());
                battery_energy_charge = parseFloat($("#battery_energy_charge").val());

                evolve_over_time();
                
                //charting
                $.plot("#chart", [{label: "battery %", data: battery_percent_status_data}, {label: "energy consumed/(consumed+produced) %", data: energy_consumption_data} ]);

            });



            function get_weather_data(yrno_xml_url){
                $.ajax({
                    type: "GET",
                    url: yrno_xml_url,
                    dataType: "xml",
                    success: function(xml) {
                        weather_data = $.xml2json(xml)['#document'].weatherdata;
                    }
                });
            }



            function get_solar_irradiance_data(dayofyear, latitude, datapoints){
                var sdata = [];
                var i = 0;
                dec = ToRad(Declination(dayofyear))
                lat = ToRad(latitude);
                x = - (Math.sin(lat) * Math.sin(dec));
                x = x / (Math.cos(lat) * Math.cos(dec));
                if (x > 1.0)
                    x = 1.0;
                if (x < -1.0)
                    x = -1.0;
                f = Math.acos(x);
                H = ToDeg(f * 1 / 15.0);
                
                sunrise = 12.0 - H;
                sunset = 12.0 + H;


                $("#siminfo").append("latitude: "+latitude+", sunrise: " + HoursMinutes(sunrise) + ", sunset: " + HoursMinutes(sunset) + " on day "+dayofyear+"<br/>");

                for (i = 0; i < datapoints; i++){
                    hour = i / 8.0;
                    Stot = 0.0;
                    if (hour > sunrise && hour < sunset) {
                        am = AM(hour, dayofyear, lat);
                        x1 = Math.pow(0.7, am);
                        Stot = Stot + 1.353 * Math.pow(x1, 0.678);
                        } else { Stot = 0}
                        if (Stot > 1.1){Stot = 0}
                    sdata[i] = Stot

                }   

                return sdata;
            }

        }(window.jQuery)

        function ToRad(c){return c*Math.PI/180}
        function ToDeg(c){return 180*c/Math.PI}
        function AM(c,e,f){dec=ToRad(Declination(e));HRA=ToRad(15*(c-12));elevation=Math.asin(Math.sin(dec)*Math.sin(f)+Math.cos(dec)*Math.cos(f)*Math.cos(HRA));declination=ToRad(90)-elevation;return 1/(1E-4+Math.cos(declination))}
        function Declination(c){return 23.45*Math.sin(ToRad(360/365*(c-81)))}
        function HoursMinutes(c){h=Math.floor(c);m=Math.floor(60*(c-h));return h.toFixed(0)+":"+m.toFixed(0)}


        function charge_battery_until_full(energy_charge){

            if(energy_charge <= battery_energy_cap){
                var percent_full = Math.floor((energy_charge/battery_energy_cap)*100);

                //$("#simresults").append(percent_full + "% charged - ");
                return battery_charging_current * battery_voltage * time_step; // V * A * h = Wh
            }else{

                //$("#simresults").append("Battery full, dissipating if ∂E > 0 - ");
                return 0;

            } 

        }


        function consume_battery_energy(energy_charge, t, t_step){
            var total_consumption = 0; //W
            var percent_hour_full = Math.floor(((t-Math.floor(t)))*100)+0.01;

            if(energy_charge <= battery_energy_cap){
                var percent_full = Math.floor((energy_charge/battery_energy_cap)*100);
            }else{
                var percent_full = 100;
            }

            //$("#simresults").append(percent_hour_full + "% of current hour");


            for (var i = system_consumers.length - 1; i >= 0; i--) {
               total_consumption += system_consumers[i].active;
            };
            

            if(percent_full > 90 && motors_on == false){
                motors_on = true;
            }

            if(percent_full < 70 && motors_on == true){
                motors_on = false;
            }

            if(motors_on == true)
            {
                for (var i = drive_consumers.length - 1; i >= 0; i--) {
                    
                    if(drive_consumers[i].active_per_hour*100 >= percent_hour_full){

                        //$("#simresults").append(" - " + drive_consumers[i].name + " - drive mode.");

                        total_consumption += drive_consumers[i].active;
                    }else{
                        total_consumption += drive_consumers[i].sleep;

                    }
                };
            }   

            if(percent_full > 50){


                for (var i = comms_consumers.length - 1; i >= 0; i--) {
                    if(comms_consumers[i].active_per_hour*100 >= percent_hour_full){
                        //$("#simresults").append(" - " + comms_consumers[i].name + ": "+ comms_consumers[i].active_per_hour*100 + "aph - comms mode.");

                        total_consumption += comms_consumers[i].active;
                    }else{
                        total_consumption += comms_consumers[i].sleep;

                    }
                };
            }

            return total_consumption*t_step; //Wh
        }


        function clear_sim(){
            $("#siminfo").html("");
            $("#simresults").html("");

            //sums
            battery_energy_charge = 0;


            //charts
            battery_percent_status_data = [];
            energy_production_data = [];
            energy_consumption_data = [];
        }


        function show_sim_info(){
            $("#siminfo").append("------------<br/>");
            $("#siminfo").append("battery_cap (battery_voltage*battery_cap): " + battery_energy_cap + "Wh </br>");
            $("#siminfo").append("battery_voltage: " + battery_voltage + "V</br>");
            $("#siminfo").append("battery_charging_current: " + battery_charging_current + "A</br>");
            $("#siminfo").append("battery_energy_charge (initial charge): " + battery_energy_charge + "Wh </br>");
            $("#siminfo").append("solar_power_produced_avg: " + solar_power_produced_avg + "W, doesn't affect simulation </br>");
            $("#siminfo").append("</br>------------ </br>");
        }

        function show_postsim_info(){
            $("#siminfo").append("# data rows: "+ battery_percent_status_data.length);
            $("#siminfo").append("<br/>time step: "+ time_step + "h , time span: " + time_limit+ "h ");

        }

        function evolve_over_time(){

            show_sim_info();


            while (time < time_limit){
                //$("#simresults").append("<hr/><i>" + time + "h: </i><br/>");

                energy_produced = charge_battery_until_full(battery_energy_charge);
                energy_consumed = consume_battery_energy(battery_energy_charge, time, time_step);
              
                battery_energy_charge += (energy_produced);
                battery_energy_charge -= (energy_consumed);
               

                battery_percent_status_data.push([time, (battery_energy_charge/battery_energy_cap)*100]);
                energy_consumption_data.push([time, (energy_consumed/(energy_produced+energy_consumed)*100)]);
 

                time=time+time_step;
                //$("#simresults").append("<br/>∂E = "+(energy_production - energy_consumption)+"</hr>");
            }

            show_postsim_info();


            //reset time
            time = 0;
        }



    </script>
    
</body>
 
</html>